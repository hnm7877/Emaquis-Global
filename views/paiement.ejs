<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.cinetpay.com/seamless/main.js"></script>
    <style>
        .sdk {
            display: block;
            position: absolute;
            background-position: center;
            text-align: center;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
    <script>
      // Injection de l'ID utilisateur courant (doit être passé côté serveur lors du render)
      const userId = '<%= user?._id || user?.id %>';
      
function checkout() {
    CinetPay.setConfig({
        apikey: '212203080763d5904661eff5.58954293',//   YOUR APIKEY
        site_id: '397031',//YOUR_SITE_ID
        notify_url: 'http://mondomaine.com/notify/',
        mode: 'PRODUCTION'
    });
    CinetPay.getCheckout({
        transaction_id: Math.floor(Math.random() * 100000000).toString(), // YOUR TRANSACTION ID
        amount: 100, // Utilisez le paramètre 'price' comme valeur pour 'amount'
        currency: '<%= currency %>',
        channels: 'ALL',
        description: 'Test de paiement',
        customer_name:"Joe",
        customer_surname:"Down",
        customer_email: "down@test.com",
        customer_phone_number: "088767611",
        customer_address : "BP 0024",
        customer_city: "Antananarivo",
        customer_country : "CM",
        customer_state : "CM",
        customer_zip_code : "06510",
    });
    CinetPay.waitResponse(function(data) {
        if (data.status == "REFUSED") {
            if (alert("Votre paiement a échoué")) {
                window.location.reload();
            }
        } else if (data.status == "ACCEPTED") {
            // Récupère le token utilisateur depuis le localStorage
            const userToken = localStorage.getItem('token');
            // Appel AJAX pour activer les options côté backend
            fetch('/api/settings/activate-options', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'token': userToken || ''
                },
                body: JSON.stringify({ userId: userId })
            })
            .then(response => response.json())
            .then(result => {
                alert("Votre paiement a été effectué avec succès");
                window.location.reload();
            })
            .catch(error => {
                alert("Paiement réussi, mais erreur lors de l'activation des options.");
                window.location.reload();
            });
        }
    });
    CinetPay.onError(function(data) {
        console.log(data);
    });
}

socket.on("connect", () => {
    $("#paiement").click(function () {
        alert("Connect");
        const price = parseInt(document.getElementById("totalBenefice").innerHTML); // Obtenez le prix à partir de la page
        checkout(price); // Passez le prix en tant que paramètre lors de l'appel de la fonction checkout()
    });
});

    </script>
</head>
<body>
    </head>
    <body>
        <div class="sdk">
            <h1>SDK SEAMLESS</h1>
            <button onclick="checkout()">Checkout</button>
        </div>
    </body>
</html>  